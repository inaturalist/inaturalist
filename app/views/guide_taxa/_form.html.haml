- content_for :extrajs do
  = javascript_include_tag :cocoon
  = javascript_include_tag "jquery/plugins/inat/photo_selectors.js"
- content_for :extracss do
  = stylesheet_link_tag "guides"
  :css
    #guide_photos textarea {height:65px;margin-bottom: 0;width:50%;}
    img.thumbnail {max-height: 200px;}
    #guide_photos .img {width: 100px;}
    #guide_photos img {max-width: 100px;}
    #guide_photos .pull-left,
    #guide_sections .pull-left {margin-right: 10px;}
    #guide_photos .row-fluid,
    #guide_sections .row-fluid {cursor: move;}
    .photoSelector {margin-bottom:10px;}
    #guide_photos input.sortable-position { background-color: orange; }
    #guide_sections input.sortable-position { background-color: DodgerBlue; }
    .readonly_field, .readonly_field label {font-size: 12px;}
    .readonly_field label { display: inline; font-weight:bold;}
    .readonly_field label:after { content: ':';}
    #guide_ranges img {max-width:300px;}
    #actions {margin-top:50px;}
- content_for :extrajs do
  :javascript
    var GUIDE_TAXON = #{raw @guide_taxon.to_json}
    $('#guide_taxon_taxon_id:visible').chooser({
      collectionUrl: '/taxa/autocomplete.json',
      resourceUrl: '/taxa/{{id}}.json?partial=chooser',
    })
    $('#edit_photos_dialog').dialog({
      modal: true, 
      title: I18n.t('choose_photos_for_this_taxon'),
      autoOpen: false,
      width: 700,
      open: function( event, ui ) {
        $('#edit_photos_dialog').loadingShades('Loading...', {cssClass: 'smallloading'})
        $('#edit_photos_dialog').load('/guide_taxa/'+GUIDE_TAXON.id+'/edit_photos', function() {
          var photoSelectorOptions = {
            defaultQuery: GUIDE_TAXON.name,
            skipLocal: true,
            baseURL: '/flickr/photo_fields',
            licensed: true,
            urlParams: {
              authenticity_token: $('meta[name=csrf-token]').attr('content'),
              limit: 14
            },
            afterQueryPhotos: function(q, wrapper, options) {
              $(wrapper).imagesLoaded(function() {
                $('#edit_photos_dialog').centerDialog()
              })
            }
          }
          $('.tabs', this).tabs({
            show: function(event, ui) {
              if ($(ui.panel).attr('id') == 'flickr_taxon_photos' && !$(ui.panel).hasClass('loaded')) {
                $('.taxon_photos', ui.panel).photoSelector(photoSelectorOptions)
              } else if ($(ui.panel).attr('id') == 'inat_obs_taxon_photos' && !$(ui.panel).hasClass('loaded')) {
                var baseURL
                if (GUIDE_TAXON.taxon_id) {
                  baseURL = '/taxa/'+GUIDE_TAXON.taxon_id+'/observation_photos'
                } else {
                  baseURL = '/taxa/observation_photos'
                }
                $('.taxon_photos', ui.panel).photoSelector(
                  $.extend(true, {}, photoSelectorOptions, {baseURL: baseURL})
                )
              } else if ($(ui.panel).attr('id') == 'eol_taxon_photos' && !$(ui.panel).hasClass('loaded')) {
                $('.taxon_photos', ui.panel).photoSelector(
                  $.extend(true, {}, photoSelectorOptions, {baseURL: '/eol/photo_fields'})
                )
              } else if ($(ui.panel).attr('id') == 'wikimedia_taxon_photos' && !$(ui.panel).hasClass('loaded')) {
                $('.taxon_photos', ui.panel).photoSelector(
                  $.extend(true, {}, photoSelectorOptions, {taxon_id: GUIDE_TAXON.id, baseURL: '/wikimedia_commons/photo_fields'})
                )
              }
              $(ui.panel).addClass('loaded')
              $('#edit_photos_dialog').centerDialog()
            }
          })
        })
      }
    })
    $('#import_sections_dialog').on('shown', function() {
      var current = $('.tab-pane:visible', this)
      if (current.hasClass('loaded')) {
        return
      }
      var provider = current.attr('id').split('_')[0]
      $.getJSON('/guide_sections/import?provider='+provider+'&q='+GUIDE_TAXON.name, function(json) {
        current.html('')
        if (!json || json.length == 0) {
          current.html("<p>"+I18n.t('no_sections_available')+"</p>")
        } else {
          $.each(json, function() {
            current.append(sectionToHtml(this))
          })
        }
      })
      current.addClass('loaded')
    })
    function sectionToHtml(section) {
      var div = $('<div></div>').addClass('lined stacked')
      div.append(
        $('<a class="right btn">'+I18n.t('import')+'</a>').click(function() {addSection(section)})
      )
      var attribution = $('<div class="small meta"></div>').html(section.attribution)
      if (section.source_url) {
        var link = $('<a></a>').attr('href', section.source_url).attr('target', '_blank')
        attribution = attribution.wrap(link)
      }
      div.append(
        $('<h3 class="title">'+section.title+'</h3>'),
        $('<div class="stacked"></div>').html(section.description),
        attribution
      )
      return div
    }
    function addSection(section) {
      $('#guide_sections_row .btn-add-section').click()
      $.each(['title', 'description', 'rights_holder', 'license', 'source_id', 'source_url'], function() {
        $('.guide-section-fields:last .'+this+'_field :input').val(section[this])
        $('.guide-section-fields:last .'+this+'_field .mirror').html(section[this])
      })
    }
    $('#import_ranges_dialog').on('shown', function() {
      var current = $('.tab-pane:visible', this)
      if (current.hasClass('loaded')) {
        return
      }
      var provider = current.attr('id').split('_')[0]
      $.getJSON('/guide_ranges/import?provider='+provider+'&q='+GUIDE_TAXON.name, function(json) {
        if (!json || json.length == 0) {
          current.html("<p>"+I18n.t('no_range_data_available')+"</p>")
        } else {
          var ul = $('<ul class="thumbnails"></ul>')
          $.each(json, function() {
            ul.append(rangeToHtml(this))
          })
          current.html(ul)
        }
      }).error(function() {
      })
      current.addClass('loaded')
    })
    function rangeToHtml(range) {
      var div = $('<div></div>').addClass('thumbnail span2 text-center')
      div.append($('<img/>').attr('src', range.thumb_url).addClass('stacked'))
      div.append(
        $('<a class="btn">'+I18n.t('import')+'</a>').click(function() {addRange(range)})
      )
      var attribution = $('<div class="small meta"></div>').html(range.attribution)
      if (range.source_url) {
        var link = $('<a></a>').attr('href', range.source_url).attr('target', '_blank')
        attribution = attribution.wrap(link)
      }
      div.append(attribution)
      return div
    }
    function addRange(range) {
      $('#guide_ranges_row .btn-add-range').click()
      $('.guide-range-fields:last img').attr('src', range.medium_url)
      $.each(['thumb_url', 'medium_url', 'original_url', 'rights_holder', 'license', 'source_id', 'source_url'], function() {
        $('.guide-range-fields:last .'+this+'_field :input').val(range[this])
        $('.guide-range-fields:last .'+this+'_field .mirror').html(range[this])
      })
    }
    function updatePositions(container, sortable) {
      $selection = $(sortable+':visible', container)
      $selection.each(function() {
        $('input[name*="position"]', this).val($selection.index(this) + 1)
      })
    }
    $('#guide_photos').sortable({
      items: "> .row-fluid",
      cursor: "move",
      placeholder: 'row-fluid stacked sorttarget',
      update: function(event, ui) {
        updatePositions("#guide_photos", ".row-fluid")  
      }
    })
    $('#guide_photos').bind('cocoon:before-remove', function(e, item) {
      $(this).data('remove-timeout', 1000)
      $(item).slideUp(function() {
        updatePositions("#guide_photos", ".row-fluid")  
      })
    })
    $('#guide_sections').sortable({
      items: "> .row-fluid",
      cursor: "move",
      placeholder: 'row-fluid stacked sorttarget',
      update: function(event, ui) {
        updatePositions("#guide_sections", ".row-fluid")  
      }
    })
    $('#guide_sections').bind('cocoon:before-remove', function(e, item) {
      $(this).data('remove-timeout', 1000)
      $(item).slideUp(function() {
        updatePositions("#guide_sections", ".row-fluid")  
      })
    })
    $('#guide_sections').bind('cocoon:after-insert', function(e, item) {
      updatePositions("#guide_sections", ".row-fluid")  
    })
    $('#guide_ranges').bind('cocoon:before-remove', function(e, item) {
      $(this).data('remove-timeout', 1000)
      $(item).slideUp()
    })
    $('#guide_sections input[type=text]').live('change', function() {
      $(this).parents('.nested-fields:first').find('input[name*=modified_on_create]').val(true)
    })
    function addTag(tag) {
      var tag = $.trim(tag)
      var tags
      if ($.trim($('#guide_taxon_tag_list').val()) == '') {
        tags = []
      } else {
        tags = $('#guide_taxon_tag_list').val().split(',').map($.trim)
      }
      if (tags.indexOf(tag) < 0) {
        tags.push(tag)
        $('#guide_taxon_tag_list').val(tags.join(', '))
      }
    }

= form_for(@guide_taxon) do |f|
  = f.hidden_field :guide_id
  = error_messages_for @guide_taxon
  .row-fluid
    .span4
      = f.label :display_name, t(:display_name)
      = f.text_field :display_name
    .span4
      = f.label :name, t(:name)
      = f.text_field :name
    .span4
      = f.label :taxon_id, t(:taxon)
      = f.text_field :taxon_id, :placeholder => "Starting typing taxon name..."
      - unless f.object.taxon_id.blank?
        .upstacked
          = link_to t(:view_taxon), taxon_path(f.object.taxon_id), :target => "_blank", :class => "readmore"
  .row-fluid.stacked
    %h3=t :photos
    #guide_photos.clearfix
      = f.fields_for :guide_photos, @guide_photos, :builder => ActionView::Helpers::FormBuilder do |gp|
        = render "guide_photo_fields", :f => gp
    = link_to_function(t(:import_photos), "$('#edit_photos_dialog').dialog('open')", :class => 'btn btn-small')
  #guide_sections_row.row-fluid.stacked
    %h3=t :description_sections
    #guide_sections.clearfix
      = f.fields_for :guide_sections, @guide_sections, :builder => ActionView::Helpers::FormBuilder do |gs|
        = render "guide_section_fields", :f => gs
    = link_to_add_association t(:add_section), f, :guide_sections, "data-association-insertion-method" => "append", "data-association-insertion-node" => "#guide_sections", :class => "btn btn-small btn-success btn-add-section"
    %button.btn-small.btn{:type => "button", :role => "button", "data-toggle" => "modal", "data-target" => "#import_sections_dialog"}=t :import_sections
  #guide_ranges_row.row-fluid.stacked
    %h3=t :ranges
    #guide_ranges.stacked.clearfix
      = f.fields_for :guide_ranges do |gs|
        = render "guide_range_fields", :f => gs
    = link_to_add_association t(:add_range), f, :guide_ranges, "data-association-insertion-method" => "append", "data-association-insertion-node" => "#guide_ranges", :class => "btn btn-small btn-success btn-add-range hide"
    / = link_to_function t(:import_ranges), "$('#import_ranges_dialog').dialog('open')", :class => "btn btn-small"
    %button.btn-small.btn{:type => "button", :role => "button", "data-toggle" => "modal", "data-target" => "#import_ranges_dialog"}=t :import_ranges

  .row-fluid.stacked
    %h3=t :tags
    %p=t 'views.guides.tags_help_html'
    %p
    = f.text_field :tag_list, :class => "input-xxlarge"
    #recent_tags.quiet
      - for tag in @recent_tags
        = link_to_function "<i class='icon-plus-sign'></i> #{tag}".html_safe, "addTag('#{tag}')", :class => "btn btn-mini"
  #actions
    = f.submit t(:save_guide_taxon), :class => "btn btn-primary"
    = link_to t(:remove_from_guide), @guide_taxon, :method => :delete, :confirm => t(:are_you_sure?), :class => "btn btn-danger pull-right"

#edit_photos_dialog.dialog
#import_sections_dialog.modal.fade.hide
  .modal-header
    %button.close{:type => "button", "data-dismiss" => "modal"} x
    %h3=t :import_sections
  .modal-body
    %ul.nav.nav-tabs
      %li.active= link_to "EOL", "#eol_sections", "data-toggle" => "tab"
      %li= link_to "Wikipedia", "#wikipedia_sections", "data-toggle" => "tab"
    .tab-content
      #eol_sections.tab-pane.active.fade.in
        = loading
      #wikipedia_sections.tab-pane.fade
        = loading
#import_ranges_dialog.modal.fade.hide
  .modal-header
    %button.close{:type => "button", "data-dismiss" => "modal"} x
    %h3=t :import_ranges
  .modal-body
    %ul.nav.nav-tabs
      %li.active= link_to "EOL", "#eol_ranges", "data-toggle" => "tab"
      / %li= link_to "Wikipedia", "#wikipedia_ranges", "data-toggle" => "tab"
      / %li= link_to "iNaturalist", "#inat_ranges", "data-toggle" => "tab"
    .tab-content
      #eol_ranges.tab-pane.active.fade.in
        = loading
      / #wikipedia_ranges.tab-pane.fade
      /   = loading
      / #inaturalist_ranges.tab-pane.fade
      /   = loading
