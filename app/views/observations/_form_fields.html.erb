<%- i ||= 0 -%>
<% fields_for observation do |o| %>
  <div class="column span-24 observation stacked">
    <% unless observation.errors.empty? %>
    <%= error_messages_for('observation', :object => observation) %>
    <% end %>
    <div class="column span-7">
      <div class="field species_guess_field">
        <%= o.label :species_guess, t(:what_did_you_see?) %>
        <%= o.text_field(:species_guess, :class => 'species_guess text') %>
        <%= o.hidden_field(:taxon_id, 
          :alt => (observation.taxon ? 
            content_tag(:span, observation.taxon.name, 
              :class => "taxon sciname #{observation.taxon.rank} #{Taxon::ICONIC_TAXA_BY_ID[observation.taxon.iconic_taxon_id].try(:name)}") : nil),
          :rel => (observation.taxon ? taxon_image_url(observation.taxon) : nil)) %>
        
        <div class="id_please">
          <%= o.check_box(:id_please) %>
          <%= o.label(:id_please, t(:full_id_please?)) %>
        </div>
      </div>
      
      <div class="field">
        <%= link_to_function t(:browse_all_species), "$('#taxonchooser').jqmShow();" %>
      </div>
      
      <div class="field<%= ' error' if observation.errors.on(:observed_on) && !observation.errors.on(:observed_on).empty? %>">
        <%= o.label :observed_on_string, t(:when_did_you_see_it?) %>
        <%= o.text_field(:observed_on_string, 
                         :class => 'observed_on_string text') %>
        <%= o.error_message_on(:observed_on) %>
        <%= o.time_zone_select :time_zone, ActiveSupport::TimeZone.us_zones, {}, {:class => 'time_zone'} %>
        <div class="small description">
          e.g. "<%= Date.today.to_s(:long) %>" or "yesterday"
        </div>
      </div>
      
      <div class="field">
        <%= o.label(:description, t(:description)) %>
        <%= o.text_area(:description, :class => "text") %>
      </div>
      
      <div class="field">
        <%= o.label :tag_list, t(:tags) %>
        <span class="small description">
          <%=t :comma_separated_please %>
        </span>
        <%= o.text_field :tag_list, :class => "text" %>
      </div>
    </div>
    <div class="column span-9">
      <div class="place_guess_field field">
        <%= o.label(:place_guess, t(:where_were_you?)) %>
        <%= o.text_field(:place_guess, :class => 'place_guess text', :placeholder => t(:name_of_the_place_you)) %>
      </div>
      <div id="coordinates_<%= i %>" class="latlonfields status">
        <%= o.label(:latitude, 'Lat') %>
        <%= o.text_field(:latitude, :class => 'latitude text') %>
        
        <%= o.label(:longitude, 'Lon') %>
        <%= o.text_field(:longitude, :class => 'longitude text') %>

        <span class="button">
          <%= link_to_function("edit", "$('#coordinates_#{i}').toggleClass('status'); $(this).hide(); $(this).next().show(); return false;") %>
          <%= link_to_function("hide", "$('#coordinates_#{i}').toggleClass('status'); $(this).hide(); $(this).prev().show(); return false;", :style => 'display: none') %>
        </span>
        <%= o.hidden_field(:map_scale, :class => 'map_scale') %>
        <%= o.hidden_field(:location_is_exact, :class => 'location_is_exact') %>
      </div>
      <div class="description"><%=t :click_on_the_map_to %></div>
      <div id="mapcontainer"></div>
      <div id="geoprivacy_<%= i %>" class="geoprivacyfield">
        <div class="stacked">
          <label><%=t :change_visibility_of %></label>
        </div>
        <label for="observations_<%= i %>_geoprivacy"><%=t :geoprivacy %></label>
        <%= o.select :geoprivacy, t( Observation::GEOPRIVACIES), :include_blank => t(:open) %>
        <span class="geoprivacy_tip_target description helptip" rel="#geoprivacy_<%= i %>_tip"></span>
        <div id="geoprivacy_<%= i %>_tip" class="geoprivacy_tip" style="display:none">
          <dl>
            <% for privacy, description in Observation::GEOPRIVACY_DESCRIPTIONS %>
              <dt><%= t( privacy ) || t(:open) %></dt>
              <dd><%= t(description) %></dd>
            <% end %>
          </dl>
        </div>
      </div>
    </div>
    <div class="last column span-8">
      <div class="field">
        <label>
          <%=t :add_photos %>
        </label>
        
        <div id="photos_<%= i %>" class="observation_photos">
          <%-
            # if the photo was invalid, we can't show new local_photos
            photos = if observation.new_record? && !observation.valid?
              observation.photos.reject do |p|
                p.is_a?(LocalPhoto)
              end
            else
              observation.photos
            end
          -%>
          <%= render :partial => "photos/photo_list_form", :locals => { 
            :photos => photos, 
            :index => i,
            :checked => true,
            :synclink_base => observation.new_record? ? new_observation_path : edit_observation_path(observation),
            :photo_identity => @photo_identities.first,
            :local_photos => @photo_identities.blank? || observation.photos.first && observation.photos.first.is_a?(LocalPhoto)
          } %>
        </div>
        
        <% if @photo_identities.blank? %>
        
          <div class="column-separator"><img src="/images/logo-eee-15px.png"></div>
          
          <p class="ui description">

            <%= raw t :we_also_support %>          </p>
          
          <div class="clear buttons">
            <%= link_to t(:link_your_flickr_account),
              {:controller => 'flickr', :action => 'link'}, :class => "button" %>
            <%= link_to t(:link_your_picasa_account),
              {:controller => 'picasa', :action => 'options'}, :class => "button" %>
            <%= link_to t(:link_your_facebook_account), "/auth/facebook", :class => "button" %>
          </div>

        <% end %>
        
        <div>
          <% if @photo_identities && @photo_identities.map(&:class).include?(FlickrIdentity) -%>
            <%= link_to_function "#{raw t(:add_taxonomic_tags_to)}",
              "var flickrPhotoParams = $.map($('#photos_#{i} input[type=checkbox]:checked'), " +
                "function(inp) {return 'flickr_photos[]='+$(inp).val()}" +
              ").join('&');" +
              "window.open('#{url_for(:controller => 'taxa', :action => 'flickr_tagger')}?" + 
                "taxon_id='+$('#observations_#{i}_taxon_id').val()+'&'+flickrPhotoParams)" %>
          <% end -%>

          <% unless observation.photos.empty? || observation.new_record? -%>
            <br/>
            <%= link_to "#{raw t(:re_order_photos)}" , edit_observation_photos_path(observation) %>
          <% end -%>
        </div>
      </div>
    </div>
    
    <% if is_admin? -%>
      <div id="morefields" class="admin column span-24">
        <h3><%=t :more_fields %></h3>
        <div class="observation_fields">
          <% o.fields_for :observation_field_values, :builder => DefaultFormBuilder do |ofv| %>
            <div id="<%= ofv.object.observation_field ? dom_id(ofv.object.observation_field) : nil %>"
                class="observation_field stacked">
              <%= ofv.hidden_field :observation_field_id, :class => "observation_field_id" %>
              <%= ofv.text_field :value, :label => h(ofv.object.observation_field.try(:name).try(:capitalize)), 
                :description => h(ofv.object.observation_field.try(:description)),
                "data-json" => ofv.object.observation_field.to_json %>
              <%= ofv.hidden_field "_destroy" %>
              <%= link_to_function t(:remove), "$(this).prev().val(1); $(this).parents('.observation_field').slideUp().attr('id', '')" %>
            </div>
          <% end -%>
        </div>
        <div>
          <%- new_ofv_fields = capture do %>
            <% o.fields_for :observation_field_values, o.object.observation_field_values.build, :builder => DefaultFormBuilder do |ofv| %>
              <div class="observation_field stacked">
                <%= ofv.hidden_field :observation_field_id, :class => "observation_field_id" %>
                <%= ofv.text_field :value, :description => "" %>
                <%= ofv.hidden_field "_destroy" %>
                <%= link_to_function t(:remove), "$(this).prev().val(1); $(this).parents('.observation_field').slideUp().attr('id', '')" %>
              </div>
            <% end -%>
          <% end -%>
          <div class="inline buttonrow">
            <label><%=t :add_a_field %></label>
            <%= content_tag :input, "",
              :name => "observation_field",
              :class => "observation_field_chooser",
              :type => :text,
              :placeholder => t(:start_typing_field_name),
              "data-chooser-default-sources" => @observation_fields.to_json %>
            <%= link_to_function t(:add_a_field), "newObservationField('#{escape_javascript(new_ofv_fields)}')", :class => "button addfieldbutton" %>
            <%= link_to t(:create_a_new_field), new_observation_field_path, :id => "createfieldbutton", :class => "button" %>
          </div>
        </div>
      </div>
    <% end -%>
    
  </div>
<% end %>
