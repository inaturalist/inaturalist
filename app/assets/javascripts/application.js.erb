// Place your application-specific JavaScript functions and classes here
// This file is automatically included by javascript_include_tag :defaults

//= require cocoon

function num2letterID(num) {
    // Takes an positive integer and translates it into a unique letter ID.
    // Examples: 0 -> A, 25 -> Z, 26 -> AA, 27 -> AB, 51 -> AZ, 52 -> BA.
    alphabet = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
    ID = alphabet[num % 26];
    return num <= 25 ? ID : alphabet[Math.floor(num/26)-1] + ID
}

function clickTip(obj, txt) {
  // Handles tip text in form elements when clicked
  if (obj.value == txt) obj.value=""; 
  obj.className = "formInput";
}

function blurTip(obj, txt) {
  // Handles tip text in form elements when blurred
  if (obj.value != "") return;
  obj.className = "formInputTip";
  obj.value = txt;
}

function toggleHeaderSubnav(link) {
  if ($(link).parents('.navtab').hasClass('open')) {
    closeHeaderSubnav(link);
  } else {
    openHeaderSubnav(link);
  }
  return false;
}

function openHeaderSubnav(link) {
  var navtab = $(link).parents('.navtab').get(0)
  $('#header .navtab').removeClass('open')
  $('#header .subnav').hide()
  $(navtab).addClass('open')
  $('.subnav', navtab).show()
  $(document).click(subnavClickOff);
  $(".ui-autocomplete").hide( );
  return false;
}

function closeHeaderSubnav(link) {
  var navtab = $(link).parents('.navtab').get(0)
  $(navtab).removeClass('open');
  $('.subnav', navtab).hide()
  $(document).unbind('click', subnavClickOff);
  return false;
}

function subnavClickOff(e) {
  if ($(e.target).parents('.navtab').length == 0) {
    $('.subnav').hide();
    $('.navtab').removeClass('open');
  }
}
var QTIP_DEFAULTS = {
  hide: {
    fixed: true
  },
  style: {
    classes: 'ui-tooltip-light ui-tooltip-shadow',
    width: 'auto'
  },
  position: {
    viewport: $(window)
  }
}


$(document).on('click', 'a[data-loading-click], button[data-loading-click], input[data-loading-click][type=radio], input[data-loading-click][type=checkbox]', loadingClickForLink)

function loadingClickForLink() {
  var txt = $(this).attr('data-loading-click')
  if ($.trim($(this).attr('data-loading-click')) == 'true') { txt = I18n.t('loading') }
  var loading = $(this).siblings('.loadingclick:first')
  if (loading.length == 0) {
    loading = $(this).clone(false)
    loading.unbind()
    loading.attr('onclick', 'return false;')
    loading.attr('href', '#')
    loading
      .attr('id', '')
      .addClass('loadingclick disabled')
      .css('padding-left', '25px')
      .html(txt)
    loading.click(function(e){
      e.preventDefault()
      return false
    })
    if (txt == '') {
      loading.find('span').html(".").css('visibility', 'hidden').css('width', '0px')
    }
    $(this).before(loading)
  }
  $(this).hide()
  $(loading).show()

  var link = this
  if (!$(this).attr('data-loading-click-bound')) {
    $(this).bind('ajax:complete', function() {
      $(link).show()
      loading.hide()
    })
    $(this).attr('data-loading-click-bound', true)
  }
}

function loadingClickForButton(options) {
  options = options || {}
  $(this).data('original-value', $(this).val())
  var txt = $.trim($(this).attr('data-loading-click'))
  if ($.trim($(this).attr('data-loading-click')) == 'true') { txt = I18n.t('saving') }
  $(this).data('original-value', $(this).val())
  $(this).addClass('disabled description').val(txt)
  var link = this
  
  if (!$(this).attr('data-loading-click-bound') && options.ajax != false) {
    $(this).parents('form').bind('ajax:complete', function() {
      $(link).attr('disabled', false).removeClass('disabled description')
      $(link).val($(link).data('original-value'))
    })
    $(this).attr('data-loading-click-bound', true)
  }
  $(link).attr('disabled', true)
}

$(document).on('click', 'input[data-loading-click][type=text], input[data-loading-click][type=submit]', function(clickEvent) {
  var button = this
  if ($(this).parents('form').length > 0) {
    if ($(this).attr("exception") != "true") {
      $(this).parents('form').submit(function(e) {
        loadingClickForButton.apply(button)
      })
    }
  } else {
    loadingClickForButton.apply(button)
  }
})

$(document).on('change', '[data-autosubmit]', function() {
  $(this).parents('form').submit()
});

function buildHelpTips() {
  if (typeof($().qtip) == "undefined") { return; }
  var options = $.extend(true, {}, QTIP_DEFAULTS, {
    show: {event: 'click'},
    hide: {event: 'unfocus'},
    position: {
      at: 'bottom center'
    }
  })
  $('.helptip').not('.helptipified').each(function() {
    $(this).addClass('helptipified')
    var content
    if ($(this).attr('rel') && $(this).attr('rel').match(/^#/)) {
      content = $($(this).attr('rel')).html()
    } else {
      content = $(this).attr('rel')
    }
    
    var tipOptions = $.extend(true, {}, options, {
      content: {
        text: content, 
        title: $(this).attr('data-helptip-title')
      }
    })
    if ($(this).data('tip-options')) {
      tipOptions = $.extend(true, {}, tipOptions, $(this).data('tip-options'))
    }
    if ($(this).attr('data-helptip-width')) {
      tipOptions.style = tipOptions.style || {}
      tipOptions.style.width = $(this).attr('data-helptip-width')
    }
    $(this).qtip(tipOptions)
  })
}

$(document).ready(function() {
  // stub jquery browser has to keep older qtip alive
  $.browser = $.browser || {}
  
  buildHelpTips()
  
  $('#usernav .signin_link, #usernav .signup_link').click(function() {
    if (window.location.pathname != '' && window.location.pathname != '/') {
      window.location = $(this).attr('href') + '?return_to=' + window.location
      return false
    }
  })
  
  $([
    '<%= image_path('spinner.gif') %>',
    '<%= image_path('spinner-small.gif') %>',
    '<%= image_path('spinner-small-ffffff_on_dedede.gif') %>',
    '<%= image_path('spinner-small-ffffff_on_aaaaaa.gif') %>'
  ]).preload()
  
  $('[data-tip]').each(autoTip)
  $('[data-popover]').each(autoPopover)
  
  $('.source_nested_form_fields input.existing').chooser({
    collectionUrl: '/sources.json',
    resourceUrl: '/sources/{{id}}.json'
  })
  
  $('.zoomable').zoomify()
  
  $('.delayedlink').click(function() {
    window.delayedLinkTries = 0
    var dialog = $('#delayedlinknotice'),
        msg = $(this).attr('data-delayed-link-msg') || 'Hold on while we generate that file...',
        status = $('<div class="loading status"></div>').html(msg)
    if (dialog.length == 0) {
      dialog = $('<div id="delayedlinknotice"></div>')
      $(document.body).append(dialog)
    }
    dialog.html(status)
    dialog.dialog({modal: true, title: 'Hold on...'})
    checkDelayedLink($(this).attr('href'))
    return false
  })
  
  $('#headerupdatesnotice').click(function() {
    toggleHeaderSubnav(this)
    if (!$('#updatessubnav').data('loaded')) {
      $('#updatessubnav').load('/users/new_updates?notification=activity,mention', function(data) {
        $(this).html(data)
        $('#updatessubnav').data('loaded', true)
        setUpdatesCount(0, {skipAnimation: true})
        var tipOptions = $.extend(true, {}, QTIP_DEFAULTS, {
          position: {
            my: 'right center',
            at: 'left center',
            target: 'event'
          },
          content: {
            text: '<span class="loading status">' + I18n.t('loading') + '</span>',
            ajax: {
              type: 'GET',
              data: {partial: 'cached_component'}
            }
          }
        })
        tipOptions.style.classes += ' compact mini observations'
        tipOptions.style.width = 250
        $('li a[href*="/observations/"]', this).each(function() {
          tipOptions.position.target = $(this).parents('li:first')
          tipOptions.content.ajax.url = $(this).attr('href')
          $(this).qtip(tipOptions)
        })
      })
    }
    return false
  })

  $('#headermessagesnotice').click(function() {
    toggleHeaderSubnav(this)
    if (!$('#messagessubnav').data('loaded')) {
      $('#messagessubnav').load('/messages/new_messages', function(data) {
        $(this).html(data)
        $('#messagessubnav').data('loaded', true)
        setMessagesCount(0, {skipAnimation: true})
      })
    }
    return false
  })
  
  $('.commentpreviewbutton').click(function() {
    var button = this
    $.ajax($(this).attr('href'), {
      type: 'POST',
      data: $(this).parents('form').serialize() + '&preview=true',
      dataType: 'json',
      beforeSend: function() {
        $(button).hide()
        $(button).nextAll('.loading').show()
      }
    })
    .done(function(data) {
      $(button).show()
      $(button).nextAll('.loading').hide()
      var html = data.html || data.body || ''
      html = '<div class="dialog">'+html+'</div>'
      $(html).dialog({
        modal: true, 
        title: I18n.t('preview'),
        width: $(window).width() * 0.7
      })
    })
    return false
  })
  
  $('.identificationform')
    .bind('ajax:before', function() {
      $('.default.button', this).hide()
      $('.loading', this).show()
    })
    .bind('ajax:complete', function() {
      $('.default.button', this).show()
      $('.loading', this).hide()
    })
    .bind('ajax:success', function(event, json, status) {
      $(this).parents('.identification_form_wrapper:first').fadeOut()
      $(this).parents('.identifications').find('.identifications-list').append(json.html)
      $(this).parents('.identifications').find('.identifications-list .identification:last').addClass('stacked')
    })
    .bind('ajax:error', function(event, request, settings) {
      var json = eval('(' + request.responseText + ')')
      if (json.errors) {
        var errors = json.errors.join(', ')
        alert('Failed to save identification: ' + errors)
      }
    })
    
  $('.friend_link').bind('ajax:before', function() {
    $(this).fadeOut(function() {
      $(this).siblings('.unfriend_link').fadeIn()
    })
  })
  $('.unfriend_link').bind('ajax:before', function() {
    $(this).fadeOut(function() {
      $(this).siblings('.friend_link').fadeIn()
    })
  })
  
  $('.commentform').bind('ajax:before', function() {
    $(this).siblings('.loading').show()
    $(this).hide()
  }).bind('ajax:complete', function() {
    $(this).siblings('.loading').hide()
    $(this).show()
    $('input[type=submit]', this).val('Save comment').attr('disabled', false)
  }).bind('ajax:success', function(e, json, status) {
    $('textarea', this).val('')
    var wrapper = $(this).parents('.comments_wrapper:first')
    wrapper.find('.comments').show()
    wrapper.find('.noresults').hide()
    wrapper.find('.comments').append(json.html)
    $('.item .item_content', wrapper).width(function() { return $(this).parent().width() - 58 })
  }).bind('ajax:error', function(xhr, status, error) {
    alert(error)
  })

  // force browsers that don't support HTML5's required attribute to recognize it
  $('form:has(input[required])').submit(checkFormForRequiredFields)

  $('body.browser .item .item_content').width(function() { return $(this).parent().width() - 58 })
  setTimeout(function() {
    $('.identification:visible .identification_body').width(function() { 
      return $(this).parent().outerWidth(true) - $(this).siblings('.identification_image').outerWidth(true) - 25
    })
  }, 1000)

  $('.dna').dnaHighlight()

  var menuCloseInitiated;
  $('#header .menutab').mouseenter( function( ) {
    openHeaderSubnav( $('a:first', this) );
    // openHeaderSubnav automatically closes all other menus,
    // so prevent any existing delayed close calls from running
    menuCloseInitiated = null;
  }).mouseleave( function( e ) {
    var item = this;
    menuCloseInitiated = Date.now( );
    setTimeout( function( checkTime ) {
      // double check that we still want to close this same menu
      if( checkTime != menuCloseInitiated ) return;
      closeHeaderSubnav( $('a:first', item) );
      $(".ui-autocomplete").hide( );
    }, 200, menuCloseInitiated );
  });
})

function checkFormForRequiredFields(e) {
  var inputs = $('input[required]:visible').filter(function() { return !$(this).val() })
  if (inputs.length == 0) {
    return true
  }
  var viewport = $(this).parents('.ui-dialog-content:first').get(0) || false
  var container = $(this).parents('.ui-dialog-content:first').get(0) || document.body
  inputs.css({'border-color': 'DeepPink'})
    .qtip({
      content: 'This field is required',
      style: {
        classes: 'ui-tooltip-light ui-tooltip-shadow ui-tooltip-required'
      },
      position: {
        viewport: viewport ? $(viewport) : false,
        container: $(container)
      }
    }).qtip('show')
  e.preventDefault()
  e.stopImmediatePropagation()
  $(window).scrollTo(inputs[0])
  return false
}

function checkDelayedLink(url) {
  if (window.delayedLinkTries > 20) {
    $('#delayedlinknotice').dialog('close')
    alert('Your request for ' + url + ' seems to be taking forever.  Please try again later.')
    return
  }
  $.ajax({
    url: url,
    type: 'get',
    statusCode: {
      // Accepted: request acnkowledged but file hasn't been generated
      202: function() {
        window.delayedLinkTries += 1
        setTimeout('checkDelayedLink("'+url+'")', 5000)
      },
      // OK: file is ready
      200: function() {
        $('#delayedlinknotice').dialog('close')
        window.location = url
      }
    }
  })
}

function autoPopover() {
  var options = $(this).data('popover')
  if (options.content && options.content.match(/^#/)) {
    content = $(options.content).html()
  } else {
    content = options.content
  }
  if (options.style && options.style.classes) {
    options.style.classes = QTIP_DEFAULTS.style.classes + " " + options.style.classes
  }
  var tipOptions = $.extend(true, {}, QTIP_DEFAULTS, options, {
    show: {event: 'click'},
    hide: {event: 'unfocus'},
    content: { 
      text: content,
      title: options.title
    }
  })
  $(this).qtip(tipOptions)
}

function autoTip() {
  if ($(this).attr('data-tip').match(/^#/)) {
    content = $($(this).attr('data-tip')).html()
  } else {
    content = $(this).attr('data-tip')
  }
  var tipOptions = $.extend(true, {}, QTIP_DEFAULTS)
  if ($(this).data('tip-options')) {
    tipOptions = $.extend(true, {}, tipOptions, $(this).data('tip-options'))
  }
  if ($(this).attr('data-tip-title')) {
    tipOptions.content = {
      text: content, 
      title: $(this).attr('data-helptip-title')
    }
  } else {
    tipOptions.content = content
  }
  
  if ($(this).attr('data-tip-show-delay')) {
    tipOptions.show = tipOptions.show || {}
    tipOptions.show.delay = parseInt($(this).attr('data-tip-show-delay'))
  }
  
  if ($(this).attr('data-tip-width')) {
    tipOptions.style = tipOptions.style || {}
    tipOptions.style.width = $(this).attr('data-tip-width')
  }
  
  if ($(this).attr('data-tip-style-classes')) {
    tipOptions.style = tipOptions.style || {}
    tipOptions.style.classes = $(this).attr('data-tip-style-classes')
  }
  
  if ($(this).attr('data-tip-position-at')) {
    tipOptions.position = tipOptions.position || {}
    tipOptions.position.at = $(this).attr('data-tip-position-at')
  }

  if ($(this).attr('data-tip-hide-delay')) {
    tipOptions.hide = tipOptions.hide || {}
    tipOptions.hide.delay = $(this).attr('data-tip-hide-delay')
  }
  
  $(this).qtip($.extend(true, {}, tipOptions))

  // remove multiple file inputs for Windows Safari
  if (navigator.platform.match(/^Win/) && $.browser.webkit && !navigator.userAgent.match(/Chrome/i)) {
    $('input[type=file]').removeAttr("multiple")
  }
}

// from http://forum.jquery.com/topic/jquery-simple-autolink-and-highlight-12-1-2010
jQuery.fn.autolink = function() {
  return this.each(function() {
    var re = /((http|https|ftp):\/\/[\w?=&.\/-;#~%-]+(?![\w\s?&.\/;#~%"=-]*>))/g;
    $(this).html( $(this).html().replace(re, '<a href="$1">$1</a> ') );
  })
}

$.fn.preload = function() {
  this.each(function(){ $('<img/>')[0].src = this; })
}

$(document).on('click', '.ui-widget-overlay, .shades', function() {
  $('.dialog:visible').dialog('close')
})

$.fn.shades = function(e, options) {
  options = options || {}
  elt = this[0]
  switch (e) {
    case 'close':
      $(elt).find('.shades:last').hide()
      break;
    case 'remove':
      $(elt).find('.shades:last').remove()
      break;
    default:
      var shades = $(elt).find('.shades:last')[0] || $('<div class="shades"></div>'),
          underlay = $('<div class="underlay"></div>'),
          overlay = $('<div class="overlay"></div>').html(options.content)
      $(shades).html('').append(underlay, overlay)
      if (options.css) { $(underlay).css(options.css) }
      if (elt != document.body) {
        $(elt).css('position', 'relative')
        $(shades).css('position', 'absolute')
        $(underlay).css('position', 'absolute')
      }
      $(elt).append(shades)
      $(shades).show()
      break;
  }
}

$.fn.loadingShades = function(e, options) {
  options = options || {}
  if (e && e == 'close') {
    $(this).shades(e, options)
  } else {
    var txt = e || I18n.t('loading'),
        cssClass = options.cssClass || 'bigloading',
        msg = '<div class="loadingShadesMsg"><span class="loading '+cssClass+' status inlineblock">'+txt+'</span></div>'
    options = $.extend(true, options, {
      css: {'background-color': 'white'}, 
      content: msg
    })
    $(this).shades('open', options)
    var status = $('.shades .loading.status', this)
    status.css({
      position: 'absolute', 
      top: options.top || '50%', 
      left: options.left || '50%', 
      marginTop: (-1 * status.outerHeight() / 2) + 'px',
      marginLeft: (-1 * status.outerWidth() / 2) + 'px'
    })
  }
}

$.fn.showInlineBlock = function() {
  var opts = {display: 'inline-block'}
  $(this).css(opts)
  return this
}

function currentTimeZone() {
  var now = new Date(),
      nowString = now.toString(),
      timeZoneAbbr = nowString.match(/\(([A-Z]{3,4})\)$/)[1],
      timeZoneOffset = nowString.match(/[+-]\d\d\d\d/)[0],
      timeZoneOffsetHours = nowString.match(/([+-]\d\d)(\d\d)/)[1],
      timeZoneOffsetMinutes = nowString.match(/([+-]\d\d)(\d\d)/)[2]
  return {
    abbreviation: timeZoneAbbr,
    offset: timeZoneOffset,
    offsetHours: parseInt(timeZoneOffsetHours),
    offsetMinutes: parseInt(timeZoneOffsetMinutes)
  }
}

$.fn.selectLocalTimeZone = function() {
  $(this).each(function() {
    var option,
        tz = currentTimeZone()
    if (tz.abbreviation) {
      var matches = $("option[data-time-zone-abbr='"+tz.abbreviation+"']", this)
      option = matches.first()
    } else if (timeZoneOffsetHour) {
      var formattedOffset = tz.offsetHours + ':' + tz.offsetMinutes
      var matches = $("option[data-time-zone-formatted-offset='"+formattedOffset+"']", this)
      option = matches.first()
    }
    if (option) {
      $(this).val(option.val())
    }
  })
  return this
}

$.fn.disable = function() { $(this).attr('disabled', true).addClass('disabled'); return this }
$.fn.enable = function() { $(this).attr('disabled', false).removeClass('disabled') ; return this }
$.fn.toggleDisabled = function() { $(this).hasClass('disabled') ? $(this).enable() : $(this).disable() }

$.fn.lock = function() {
  $(this).each(function() {
    var replacement = $(this).clone()
    replacement.attr('name', '').val($(this).val()).addClass('lock-replacement').disable()
    $(this).after(replacement)
    $(this).hide().data('locked', true)
  })
}
$.fn.unlock = function() {
  $(this).each(function() {
    $(this).nearest('.lock-replacement').remove()
    $(this).show().data('locked', false)
  })
}
$(document).ready(function() {
  $(':input[data-locked]').lock()
})

$.fn.zoomify = function() {
  var selection = $(this).not('.zoomified')
  selection
    .addClass('zoomified')
    .addClass('inlineblock')
    .append('<img src="<%= image_path('silk/magnifier.png') %>" class="zoom_icon"/>')
  selection.click(function() {
    if ($('#zoomable_dialog').length == 0) {
      $(document.body).append(
        $('<div></div>').attr('id', 'zoomable_dialog').addClass('dialog')
      )
    }
    $('#zoomable_dialog').html('<div class="loading status">' + I18n.t('loading') + '</div>')
    $('#zoomable_dialog').load($(this).attr('href'), "partial=photo", function() {
      
      $('img', this).load(function() {
        var dialog = $('#zoomable_dialog'),
            newHeight = $(':first', dialog).height() + 60,
            maxHeight = $(window).height() * 0.8
        if (newHeight > maxHeight) { newHeight = maxHeight };
        $(dialog).dialog('option', 'height', newHeight)
        $(dialog).dialog('option', 'position', {my: 'center', at: 'center', of: $(window)})
      })
    })
    $('#zoomable_dialog').dialog({
      modal: true, 
      title: $(this).attr('title') || $(this).attr('alt'),
      width: $(window).width() * 0.8
    })
    return false
  })
}

$.fn.slideToggleWidth = function() {
  $(this).each(function() {
    if ($(this).attr('data-original-width') && $(this).attr('data-original-width') != $(this).width()) {
      $(this).show()
      $(this).animate({
        width: $(this).attr('data-original-width')
      }, 500)
    } else {
      $(this).attr('data-original-width', $(this).width())
      $(this).animate({width:0}, 500, function() {$(this).hide()})
    }
  })
}

$.fn.centerInContainer = function(options) {
  options = options || {}
  var containerSelector = options.container || ':first'
  $(this).not('.centeredInContainer').each(function() {
    var container = $(this).parents(containerSelector),
        containerWidth = container.width(),
        containerHeight = container.height(),
        w = $(this).naturalWidth(),
        h = $(this).naturalHeight()
    if (w > h) {
      var width = containerHeight / h * w
      $(this).css({height: containerHeight, maxWidth: 'none', position:'absolute'})
      $(this).css({
        top: 0, 
        left: '50%', 
        marginLeft: '-' + (width / 2) + 'px'
      })
    } else if (w < h) {
      var height = containerWidth / w * h
      $(this).css({width: $(this).parents(containerSelector).width(), maxHeight: 'none', position: 'absolute'})
      $(this).css({left: 0, top: '50%', marginTop: '-' + (height / 2) + 'px'})
    } else if (w == 0 && h == 0) {
      var that = this
      // hack for ff
      setTimeout(function() {
        $(that).centerInContainer(options)
      }, 500)
      return
    } else {
      $(this).css({width: $(this).parents(containerSelector).width(), maxWidth: 'none', maxHeight: 'none'})
      $(this).css({left: 0, top: 0, marginTop: '0px'})
    }
    $(this).addClass('centeredInContainer')
  })
}

$.fn.observationsGrid = function(size) {
  $(this).removeClass('mini map')
  $(this).addClass('observations grid')
  $('.observation', this).showInlineBlock()
  $('.map', this).hide()
  var that = this
  if (size == 'medium') {
    $(this).addClass('medium')
    $('.photos img[data-small-url]', this).each(function() { 
      $(this).load(function() {
        $(this).centerInContainer({container: '.observation:first'})
        $(this).fadeIn()
        $(this).unbind('load')
      })      
      $(this).attr('src', $(this).attr('data-small-url'))
      $(this).hide()
    })
    $('.icon img[data-small-url]', this).each(function() {
      $(this).attr('src', $(this).attr('data-small-url')) 
    })
  } else {
    $(that).removeClass('medium')
    $('.photos img[data-square-url]', that).attr('style', '')
    $('.photos img[data-square-url]', that).removeClass('centeredInContainer')
    $('.photos img[data-square-url]', that).attr('src', function() { return $(this).attr('data-square-url')})
    $('.icon img[data-square-url]', that).attr('src', function() { return $(this).attr('data-square-url')})
  }
}

$.fn.observationsList = function() {
  $('.observation', this).show().css('display', 'block')
  $('.map', this).hide()
  $(this).removeClass('medium grid map')
  $(this).addClass('mini')
  $('.photos img[data-square-url]', this).attr('style', '')
  $('.photos img[data-square-url]', this).removeClass('centeredInContainer')
  $('.photos img[data-square-url]', this).attr('src', function() { return $(this).attr('data-square-url')})
  $('.icon img[data-square-url]', this).attr('src', function() { return $(this).attr('data-square-url')})
}

$.fn.observationsMap = function() {
  $(this).observationsList()
  $(this).removeClass('medium grid mini')
  $(this).addClass('map')
  $(this).each(function() {
    if ($('.map', this).length > 0) {
      $('.map', this).show()
      google.maps.event.trigger($('.map', this).get(0), 'resize')
      return
    }
    var w = $(this).width(),
        h = $(window).height() / $(window).width() * w,
        mapDiv = $('<div></div>')
    mapDiv.addClass('stacked map')
    mapDiv.width(w)
    if ($(this).data('map-height') == 'this') {
      mapDiv.height($(this).height())
    } else {
      mapDiv.height(h)
    }
    $(this).prepend(mapDiv)
    var map = iNaturalist.Map.createMap({div: mapDiv.get(0)})
    $('.observation', this).each(function() {
      var o = {
        id: $(this).attr('id').split('-')[1],
        latitude: $(this).attr('data-latitude'),
        longitude: $(this).attr('data-longitude'),
        coordinates_obscured: $(this).attr('data-coordinates-obscured'),
        taxonId: $(this).attr('data-taxon-id'),
        iconic_taxon: {
          name: $(this).attr('data-iconic-taxon-name')
        }
      }
      map.addObservation(o)
    })
    map.zoomToObservations()
  })
  $('.observation', this).hide()
}


$.fn.observationControls = function(options) {
  var options = options || {}
  $(this).each(function() {
    var observations = options.div || $(this).parent().find('.observations')

    var gridButton = $('.gridbutton', this)
    if (!options.skipGrid && gridButton.length == 0) {
      gridButton = $('<a href="#" class="gridbutton" title="'+I18n.t('grid_tooltip')+'"><span class="inat-icon ui-icon ui-icon-grid inlineblock">&nbsp;</span><label>'+I18n.t('grid')+'</label></a>')
      gridButton.data('gridSize', $(observations).hasClass('medium') ? 'medium' : null)
      gridButton.click(function() {
        $(observations).observationsGrid($(this).data('gridSize'))
        $(this).siblings().addClass('disabled')
        $(this).removeClass('disabled')
        return false
      })
    }

    var listButton = $('.listbutton', this)
    if (!options.skipList && listButton.length == 0) {
      listButton = $('<a href="#" class="listbutton" title="'+I18n.t('list_tooltip')+'"><span class="inat-icon ui-icon ui-icon-list inlineblock">&nbsp;</span><label>'+I18n.t('list')+'</label></a>')
      listButton.click(function() {
        $(observations).observationsList()
        $(this).siblings().addClass('disabled')
        $(this).removeClass('disabled')
        return false
      })
    }

    var mapButton = $('.mapbutton', this)
    if (!options.skipMap && mapButton.length == 0) {
      mapButton = $('<a href="#" class="mapbutton" title="'+I18n.t('map_tooltip')+'"><span class="inat-icon ui-icon ui-icon-map inlineblock">&nbsp;</span><label>'+I18n.t('map')+'</label></a>')
      mapButton.click(function() {
        $(observations).observationsMap()
        $(this).siblings().addClass('disabled')
        $(this).removeClass('disabled')
        return false
      })
    }
    
    if ($(this).children().length == 0) {
      $(this).append(' ', gridButton, listButton, mapButton)
    }

    if ($(observations).hasClass('grid')) {
      gridButton.click()
    } else if ($(observations).hasClass('map')) {
      mapButton.click()
    } else {
      listButton.click()
    }
  })
}

$.fn.naturalWidth = function() {
  var img = $(this).get(0)
  var fakeImg = new Image()
  fakeImg.src = $(this).attr('src')
  return fakeImg.width
}

$.fn.naturalHeight = function() {
  var img = $(this).get(0)
  var fakeImg = new Image()
  fakeImg.src = $(this).attr('src')
  return fakeImg.height
}


function setUpdatesCount(count, options) {
  options = options || {}
  if (count > 0) {
    if (options.skipAnimation) {
      $('#header .updates').addClass('hasupdates')
    } else {
      $('#header .updates').switchClass('', 'hasupdates')
    }
    $('#header .updates .count').html(count)
  } else {
    if (options.skipAnimation) {
      $('#header .updates').removeClass('hasupdates')
    } else {
      $('#header .updates').switchClass('hasupdates', '')
    }
    $('#header .updates .count').html(0)
  }
}

function getUpdatesCount() {
  $.getJSON('/users/updates_count.json', function(data) {
    setUpdatesCount(data.count)
  })
}

function setMessagesCount(count, options) {
  options = options || {}
  if (count > 0) {
    if (options.skipAnimation) {
      $('#header .messages').addClass('hasupdates')
    } else {
      $('#header .messages').switchClass('', 'hasupdates')
    }
    $('#header .messages .count').html(count)
  } else {
    if (options.skipAnimation) {
      $('#header .messages').removeClass('hasupdates')
    } else {
      $('#header .messages').switchClass('hasupdates', '')
    }
    $('#header .messages .count').html(0)
  }
}

function getMessagesCount() {
  $.get('/messages/count', function(data) {
    setMessagesCount(data.count)
  })
}

$.fn.subscriptionSettings = function() {
  var options = $.extend(true, {
    position: {
      my: 'top right',
      at: 'bottom center'
    },
    show: {
      event: 'click'
    },
    hide: {
      event: 'unfocus'
    },
    content: {
      text: '<span class="loading status">' + I18n.t('loading') + '</span>',
      ajax: {
        type: 'GET',
        data: {partial: 'edit_inline'},
        error: function(jqXHR, textStatus, errorThrown) {
          this.set('content.text', "<div class='meta'>You're no longer subscribed to that item.</div>")
        },
        success: function(data, status) {
          this.set('content.text', data);
          $('.taxonchooser', this.elements.content).simpleTaxonSelector({
            afterSelect: function(wrapper, taxon, options) {
              var form = $(wrapper).parents('form:first'),
                  data = form.serialize() + '&format=json'
              $.ajax({
                url: form.attr('action'),
                type: 'post',
                data: data
              })
            }
          })
          $('.createdestroy form', this.elements.content).submit(function() {
            $(this).fadeOut(function() {
              $(this).siblings('form').fadeIn()
            })
            var data = $(this).serialize() + '&format=json',
                resourceType = $('input[name*=resource_type]', this).val(),
                resourceId = $('input[name*=resource_id]', this).val()
            $.ajax({
              url: $(this).attr('action'),
              type: 'post',
              data: data
            })
            if ($(this).hasClass('unsubscribe')) {
              $('.subscription_for_'+resourceType+'_'+resourceId).addClass('unsubscribed')
            } else {
              $('.subscription_for_'+resourceType+'_'+resourceId).removeClass('unsubscribed')
            }
            return false
          })
        }
      }
    }
  }, QTIP_DEFAULTS)
  $(this).each(function() {
    var thisOptions = $.extend({}, options);
    if( thisOptions.content.ajax ) {
      thisOptions.content.ajax.url = $(this).attr('href');
    }
    // custom text for qtip popup
    if( $(this).data("gear-text") ) {
      var text = $(this).data("gear-text");
      // custom URL to make the text a link
      if( $(this).data("gear-url") ) {
        text = "<a href='"+ $(this).data("gear-url") +"'>"+ text +"</a>";
      }
      thisOptions.content = {
        text: "<div class='meta'>"+ text +"</div>"
      };
      thisOptions.ajax = null;
    }
    if ( $( this ).data( "remote" ) === false ) {
      thisOptions.content.ajax.success = function( data, status ) {
        this.set('content.text', data);
        $('.taxonchooser', this.elements.content).simpleTaxonSelector({
          afterSelect: function(wrapper, taxon, options) {
            var form = $(wrapper).parents('form:first'),
                data = form.serialize() + '&format=json'
            $.ajax({
              url: form.attr('action'),
              type: 'post',
              data: data
            })
          }
        })
      }
    }
    $(this).qtip(thisOptions)
    $(this).click(function() {return false})
  })
}

// http://www.shamasis.net/2009/09/fast-algorithm-to-find-unique-items-in-javascript-array/
Array.prototype.unique = function() {
  var o = {}, i, l = this.length, r = [];
  for(i=0; i<l;i+=1) o[this[i]] = this[i];
  for(i in o) r.push(o[i]);
  return r;
}

// http://stackoverflow.com/questions/1184624/convert-form-data-to-js-object-with-jquery
$.fn.serializeObject = function() {
    var o = {};
    var a = this.serializeArray();
    $.each(a, function() {
        if (o[this.name] !== undefined) {
            if (!o[this.name].push) {
                o[this.name] = [o[this.name]];
            }
            o[this.name].push(this.value || '');
        } else {
            o[this.name] = this.value || '';
        }
    });
    return o;
}

$.fn.centerDialog = function() {
  if ($(this).children().length == 1) {
    var newHeight = $(':first', this).height() + 100
  } else {
    var newHeight = $(this).height() + 100
  }
  var maxHeight = $(window).height() * 0.8
  if (newHeight > maxHeight) { newHeight = maxHeight };
  $(this).dialog('option', 'height', newHeight)
  $(this).dialog('option', 'position', {my: 'center', at: 'center', of: $(window)})
}

$(document).on('click', '.flaglink', function() {
  $('#flagdialog').remove()
  var dialog = $('<div></div>').attr('id', 'flagdialog')
    .addClass('dialog')
    .html('<div class="loading status">' + I18n.t('loading') + '</div>')
  dialog.load($(this).attr('href'), "partial=dialog", function() {
    $(this).centerDialog()
    $('input[type=radio]', this).change(function() {
      if ($(this).val() == 'other') {
        $(this).parents('.dialog:first').find('textarea').show()
        $(this).parents('.dialog:first').centerDialog()
      } else {
        $(this).parents('.dialog:first').find('textarea').hide()
        $(this).parents('.dialog:first').centerDialog()
      }
    })
  })
  $(document.body).append(dialog)
  dialog.dialog({modal: true, title: I18n.t('flag_an_item')})
  return false
})

function serialID() {
  window._serialID = window._serialID ? window._serialID + 1 : 1
  return window._serialID
}

function setPreference(pref, value) {
  var url = $('#usersubnav .profile_link:first').attr('href')
  if (!url || !pref || !value) { return }
  var data = {
    authenticity_token: $('meta[name=csrf-token]').attr('content'),
    _method: 'PUT'
  }
  data['user[preferred_'+pref+']'] = value
  $.ajax(url, {
    type: 'POST',
    data: data,
    dataType: 'json'    
  })
}

$(document).on('ajax:success', '.project_user_invitation .acceptlink', function() {
  $(this).hide()
  $(this).siblings('.status').html(I18n.t('joined!')).show().addClass('success').removeClass('loading')
})
$(document).on('ajax:before', '.project_user_invitation .acceptlink', function() {
  $(this).hide()
  $(this).siblings('.status').html(I18n.t('loading')).show().addClass('loading')
})

function showJoinProjectDialog(projectId, options) {
  options = options || {}
  var url = options.url || '/projects/'+projectId+'/join?partial=join',
      title = options.title || I18n.t('join_project'),
      originalInput = options.originalInput
  var dialog = $('<div></div>').addClass('dialog').html('<div class="loading status">' + I18n.t('loading') + '</div>')
  dialog.load(url, function() {
    // ajaxify join
    var button = $('.default.button', this),
        diag = this
    button.click(function(e) {
      var joinUrl = $(this).attr('href')
      $.post(joinUrl).done(function() {
        $(diag).dialog('close')
        if (originalInput) {
          $(originalInput).click()
        }
      }).fail(function() {
        alert('Failed to join project')
      })
      return false
    })
    $(this).centerDialog()
  })
  dialog.dialog({
    modal: true,
    title: title,
    width: 600,
    maxHeight: $(window).height() * 0.8,
  })
}


// http://stackoverflow.com/a/14839776/720268
function preciseRound(num,decimals) {
  return Math.round(num*Math.pow(10, decimals)) / Math.pow(10,decimals)
}

function updateSession(params) {
  $.ajax({
    url: '/users/update_session',
    data: params,
    type: 'PUT'
  })
}

$.fn.loadObservations = function(options) {
  var url = options.url || '/observations'
  if (!url.match(/partial=/)) {
    url += url.match(/\?/) ? '&' : '?'
    url += 'partial=cached_component'
  }
  var container = this
  var req
  req = $.ajax({
    type: "GET",
    url: url,
    success: function (data, status) {
      var html = data.replace(/\/div>[\s\n]+?<div/g, '/div><div')
      var oldObsId = $('.observation:first', container).attr('id')
      if (oldObsId) {
        var r = new RegExp('^[^>]+'+oldObsId, 'g')
        if (r.test(html)) {
          return
        }
      }
      $(container).html(html)
      if (options.style == 'list') {
        $(container).observationsList()
      } else if (options.style == 'map') {
        $(container).observationsMap()
      } else {
        $(container).observationsGrid('medium')
      }
      if (typeof(options.success) == 'function') {
        options.success(req, data, status)
      }
    }
  })
  if (options.refresh) {
    var t = setTimeout(function() {
      container.loadObservations(options)
    }, options.refresh)
    container.data('loadObservationsTimeout', t)
  }
}

$.fn.observationTaxonStats = function(options) {
  var options = options || {},
      container = this,
      baseSearch = typeof(OBSERVATIONS_URL) == 'undefined' ? window.location.search : '?'+OBSERVATIONS_URL.split('?')[1],
      limit = options.limit || 5,
      url = options.url || '/observations/taxon_stats.json?limit'+limit
  baseSearch = baseSearch.replace(/per_page=[^&]+/, '')
  baseSearch = baseSearch.replace(/page=[^&]+/, '')
  $.getJSON(url, function(json) {
    var speciesCount
    if (json.rank_counts.leaves) {
      speciesCount = json.rank_counts.leaves
    } else {
      speciesCount = 
        (json.rank_counts.species || 0) +
        (json.rank_counts.subspecies || 0) +
        (json.rank_counts.variety || 0) +
        (json.rank_counts['form'] || 0) +
        (json.rank_counts.hybrid || 0)
    }
    var speciesCountLink = $('<a>'+speciesCount+'</a>').attr('href', '/observations/taxa'+ baseSearch +'&hrank=species')
    $('.species .count', container).html(speciesCountLink)
    if (json.species_counts.length > 0) {
      var most
      $('.most_observed table', container).html('')
      for (var i = 0; i < json.species_counts.length; i++) {
        if (json.species_counts[i].taxon) {
          most = json.species_counts[i]
          var tr = $('<tr></tr>'),
              taxonTD = $('<td class="taxon"></td>'),
              imageTD = $('<td class="image"></td>')
          taxonTD.html(
            $('<a></a>').
              addClass('nobr '+(most.taxon.default_name.lexicon == 'Scientific Names' ? 'scientific' : '')).
              attr('href', '/taxa/'+most.taxon.id).
              html(most.taxon.default_name.name)
          )
          imageTD.append($('<img/>').attr('src', most.taxon.image_url))
          taxonTD.append(
            $('<div class="meta"></div>').append(
              I18n.t('x_observations_link_html', {
                count: most.count,
                url: '/observations'+baseSearch+'&taxon_id='+most.taxon.id
              })
            )
          )
          tr.append(imageTD, taxonTD)
          $('.most_observed table', container).append(tr)
        }
      }
    }
    if (options.refresh) {
      var t = setTimeout(function() {
        container.observationTaxonStats(options)
      }, options.refresh)
      container.data('observationTaxonStatsTimeout', t)
    }
  })
}

$.fn.observationUserStats = function(options) {
  var url = options.url || '/observations/taxon_stats.json',
      container = this,
      baseSearch = typeof(OBSERVATIONS_URL) == 'undefined' ? window.location.search : '?'+OBSERVATIONS_URL.split('?')[1]
  baseSearch = baseSearch.replace(/per_page=[^&]+/, '')
  baseSearch = baseSearch.replace(/page=[^&]+/, '')
  $.getJSON(url, function(json) {
    var total = json.total || 0,
        totalLink = $('<a>'+total+'</a>').attr('href', '/observations/user_stats'+baseSearch)
    $('.people .count', container).html(totalLink)
    if (json.most_observations.length > 0) {
      $('.most_observations table', container).html('')
      for (var i = 0; i < json.most_observations.length; i++) {
        var most = json.most_observations[i],
            img_url = most.user.user_icon_url || '/attachment_defaults/users/icons/defaults/thumb.png',
            tr = $('<tr></tr>'),
            imageTD = $('<td class="image"></td>'),
            userTD = $('<td class="user"></td>')
        imageTD.append(
          $('<a></a>').attr('href', '/people/'+most.user.login).append(
            $('<img/>').attr('src', img_url).addClass('usericon')
          )
        )
        userTD.html($('<a>'+most.user.login+'</a>').attr('href', '/people/'+most.user.login))
        userTD.append(
          $('<div></div>').
            addClass('meta').
            html(I18n.t('x_observations_link_html', {
              count: most.count,
              url: '/observations'+baseSearch+'&user_id='+most.user.login
            }))
        )
        tr.append(imageTD, userTD)
        $('.most_observations table', container).append(tr)
      }
    }
    if (json.most_species.length > 0) {
      $('.most_species table', container).html('')
      for (var i = 0; i < json.most_species.length; i++) {
        var row = json.most_species[i]
            img_url = row.user.user_icon_url || '/attachment_defaults/users/icons/defaults/thumb.png',
            tr = $('<tr></tr>'),
            imageTD = $('<td class="image"></td>'),
            userTD = $('<td class="user"></td>')
        imageTD.append($('<img/>').attr('src', img_url).addClass('usericon'))
        userTD.html($('<a>'+row.user.login+'</a>').attr('href', '/people/'+row.user.login))
        userTD.append(
          $('<div></div>').
            addClass('meta').
            html(I18n.t('x_species_link_html', {
              count: row.count, 
              url: '/observations/taxa'+baseSearch+'&user_id='+row.user.login+'&hrank=species'
            }))
        )
        tr.append(imageTD, userTD)
        $('.most_species table', container).append(tr)
      }
    }
    if (options.refresh) {
      var t = setTimeout(function() {
        container.observationUserStats(options)
      }, options.refresh)
      container.data('observationUserStats', t)
    }
  })
}

$.fn.dnaHighlight = function() {
  $(this).each(function() {
    var newt = "",
        oldt = $(this).text()
    for (var i = 0; i < oldt.length; i++) {
      switch (oldt[i]) {
        case 'A':
          newt += '<nt class="a">'+oldt[i]+'</nt>'
          break
        case 'T':
          newt += '<nt class="t">'+oldt[i]+'</nt>'
          break
        case 'C':
          newt += '<nt class="c">'+oldt[i]+'</nt>'
          break
        case 'G':
          newt += '<nt class="g">'+oldt[i]+'</nt>'
          break
        default:
          newt += oldt[i]
      }
    }
    $(this).html(newt)
  })
}

$.fn.textcompleteUsers = function( ) {
  var field = this;
  field.textcomplete([{
    index: 1,
    match: /\B@([\\\w][\\\w\\\-_]*)$/,
    search: function( term, callback ) {
      $.getJSON( "/people/search.json", { q: term, order: "activity" } ).
        done(function( data ) {
          callback( $.map( data, function( user ) {
            return user.html;
          }));
        }
      );
    },
    replace: function( html ) {
      var login, matches;
      // extract the username from the HTML
      if( matches = html.match( /\(([^ ]+)\)<\/div>/ )) {
        login = matches[1];
      } else if( matches = html.match( / ([^ ]+)<\/div>/ )) {
        login = matches[1];
      }
      // setTimeout(function(){ field.data("highlighter").highlight() }, 10);
      return "@" + login + " ";
    }
  }]);
}

$.fn.boldId = function() {
  $(this).each(function() {
    if ($('.boldid', this).length > 0) return
    var bolddb
    if ($(this).hasClass('bold-its')) {
      // not implemented by BOLD
    } else if ($(this).hasClass('bold-matk')) {
      // not implemented by BOLD
    } else {
      bolddb = 'COX1'
    }
    if (!bolddb) return
    var boldWrapper = $('<span class="boldid"><label><a href="http://www.boldsystems.org/">BOLD</a> DNA Match:</label></span>'),
        boldLink = $('<span class="button inline status"><a href="#">Load DNA-based identification from BOLD</a></span>')
    boldWrapper.append(' ', boldLink)
    boldLink.click(function() {
      $(this).hide()
      $('.status', boldWrapper).replaceWith('<span class="loading status inline">Loading BOLD ID...</span>')
      $.get(url, function(data, status, jqXHR) {
        var name = $('match:first taxonomicidentification', data).text(),
            similarity = $('match:first similarity', data).text(),
            specimenURL = $('match:first url', data).text()
        similarity = preciseRound(parseFloat(similarity) * 100, 2)
        if (!name) {
          $('.status', boldWrapper).replaceWith(
            '<span class="status">No matches</span>'
          )
          return
        }
        $.getJSON('/taxa/search?q='+name, function(taxa) {
          var taxon
          for (var i = 0; i < taxa.length; i++) {
            if (taxa[i].name == name) {
              taxon = taxa[i]
              break
            }
          }
          if (taxon) {
            var cssClass = 'taxon ' + [taxon.rank, taxon.iconic_taxon_name].join(' ')
            $('.status', boldWrapper).replaceWith(
              '<span class="iconic_taxon_sprite '+taxon.iconic_taxon_name.toLowerCase()+' selected">&nbsp;</span> ' +
              '<span class="'+cssClass+'"><a href="/taxa/'+taxon.id+'"><span class="sciname">'+name+'</span></span></span>'
            )
          } else {
            $('.status', boldWrapper).replaceWith(
              '<span class="taxon"><span class="sciname">'+name+'</span></span>'
            )
          }
          $(boldWrapper).append(' <span class="meta">('+ similarity + '% match)</span>')
          $(boldWrapper).append(' <a href="'+specimenURL+'" class="readmore">View matching specimen on BOLD</a>')
        })
      })
      return false
    })
    $(this).after(boldWrapper)
    var url = "/identifications/bold.xml?db="+bolddb+"&sequence="+$(this).text()
  })
}

$.fn.leaderboard = function(options) {
  $(this).addClass('leaderboard-container')
  var htmltable = $(this).html(
    $('<table class="table">').append(
      $('<thead>').append(
        $('<tr>').append(
          $('<th>').append('#'),
          $('<th class="user">').append(I18n.t('user')),
          $('<th class="numeric">').append(I18n.t('observations')),
          $('<th class="numeric">').append(I18n.t('species'))
        )
      ),
      $('<tbody>')
    )
  )
  // http://stackoverflow.com/questions/17732714/datatables-js-sort-columns-containing-html-links-with-integer-text
  jQuery.fn.dataTableExt.oSort['numeric-html-asc'] = jQuery.fn.dataTableExt.oSort['numeric-html-asc'] || function(a,b) {
    if (!a.toString().match(/^\d+$/)) {
      a = parseInt($(a).text()) || 0
      b = parseInt($(b).text()) || 0
    }
    return ((a < b) ? -1 : ((a > b) ?  1 : 0))
  }
  jQuery.fn.dataTableExt.oSort['numeric-html-desc'] = jQuery.fn.dataTableExt.oSort['numeric-html-desc'] || function(a,b) {
    if (!a.toString().match(/^\d+$/)) {
      a = parseInt($(a).text()) || 0
      b = parseInt($(b).text()) || 0
    }

    return ((a < b) ? 1 : ((a > b) ?  -1 : 0))
  }
  var table = $('table', this).DataTable({
    "bPaginate": false,
    "bLengthChange": false,
    "bFilter": false,
    "bInfo": false,
    "aaSorting": [[2,'desc']],
    "aoColumns": [
      {"bSortable": false},
      {"sType": "html", "sClass": "user"},
      {"sType": "numeric-html", "sClass": "numeric", "orderSequence": ["desc", "asc"]},
      {"sType": "numeric-html", "sClass": "numeric", "orderSequence": ["desc", "asc"]}
    ],
    fnDrawCallback: function ( oSettings ) {
        var that = this;
        /* Need to redo the counters if filtered or sorted */
        if ( oSettings.bSorted || oSettings.bFiltered ) {
          this.$('td:first-child', {"filter":"applied"}).each( function (i) {
              that.fnUpdate( i+1, this.parentNode, 0, false, false );
          })
        }
    }
  })
  htmltable.loadingShades()
  $.getJSON('/observations/user_stats?'+$.param(options), function(data) {
    htmltable.shades('close')
    var users = {}
    $.each(data.most_observations, function() {
      users[this.user.id] = {user: this.user, observations: this.count}
    })
    $.each(data.most_species, function() {
      users[this.user.id] = users[this.user.id] || {user: this.user}
      users[this.user.id].species = this.count
    })
    $.each(users, function(i) {
      var linkOptions = $.extend({}, options, true)
      delete linkOptions.limit
      var userLink = $('<a>')
          .attr('href', '/people/'+this.user.login)
          .html(
            $('<img>').attr('src', this.user.user_icon_url || '<%= image_path(User.new.icon.url(:thumb)) %>')
          ).prop('outerHTML') +
        $('<a>')
          .attr('href', '/people/'+this.user.login)
          .html(this.user.login).prop('outerHTML')
      var obsLink = $('<a>')
        .attr('href', '/observations/'+this.user.login+'?'+$.param(linkOptions))
        .html(this.observations || '*')
        .prop('outerHTML')
      var sppLink = $('<a>')
        .attr('href', '/observations/taxa?'+$.param($.extend({}, linkOptions, {user_id: this.user.login, hrank: 'species'}, true)))
        .html(this.species || '*')
        .prop('outerHTML')
      var row = [
        i,
        userLink,
        obsLink,
        sppLink
      ]
      table.row.add(row)
    })
    table.draw()
  })
}

$.fn.isolatedScroll = function( ) {
  this.bind( "mousewheel DOMMouseScroll", function ( e ) {
    var delta = e.wheelDelta || ( e.originalEvent && e.originalEvent.wheelDelta ) || -e.detail,
      bottomOverflow = this.scrollTop + $( this ).outerHeight( ) - this.scrollHeight >= 0,
      topOverflow = this.scrollTop <= 0;
    if( ( delta < 0 && bottomOverflow ) || ( delta > 0 && topOverflow ) ) {
      e.preventDefault( );
    }
  });
  return this;
};

// used to provide a jquery-ui modal dialog confirmation
// currently limited to submitting forms, but could easily
// be extened to use with links
$.fn.confirmModal = function( options ) {
  var that = this;
  var action = $(this).is("form") ? "submit" : "click";
  that.on( action, function( e, opts ) {
    // `Proceed` will force click, and we want that to submit
    if( opts && opts.forceSubmit ) { return; }
    // don't show the modal unless the condition is met
    if( _.isFunction( options.condition ) && !options.condition( ) ) { return; }
    // skip the form submit
    e.preventDefault( );

    var dialogDiv = $( "<div/>" ).addClass( "dialog" );
    // prepare Proceed/Cancel buttons
    var confirm = $( "<input/>" ).addClass( "default button" ).
      attr({ type: "button", value: I18n.t( "proceed" ) });
    var cancel = $( "<input/>" ).addClass( "button" ).
      attr({ type: "button", value: I18n.t( "cancel" ) });
    // prepare Proceed/Cancel actions
    confirm.on( "click", function( ) {
      dialogDiv.dialog( "close" );
      that.trigger( action, { forceSubmit: true } );
    });
    cancel.on( "click", function( ) {
      dialogDiv.dialog( "close" );
      if( _.isFunction( options.onCancel ) ) {
        options.onCancel( );
      }
    });

    // populate and display the modal dialog
    var buttonsDiv =  $( "<div/>" ).addClass( "foot" ).
      append( confirm ).append( cancel );
    if( options.silencePreference ) {
      var checkbox = $( "<input type='checkbox' id='silence' />" );
      checkbox.on( "click", function( ) {
        var pref = { };
        pref[ options.silencePreference ] = $(this).is(":checked");
        updateSession( pref );
      });
      buttonsDiv.append( checkbox );
      buttonsDiv.append( $( "<label for='silence'>" ).
        append( I18n.t( "do_not_show_this_message_again" ) ));
    }
    // text might be a method that is evaluated in real time
    var text = _.isFunction( options.text ) ? options.text( ) : options.text; 
    dialogDiv.append( $( "<p/>" ).append( text ) ).append( buttonsDiv );
    $( document.body ).append( dialogDiv )
    dialogDiv.dialog({ modal: true, title: I18n.t( "attention" ),
      dialogClass: "confirm-modal", minWidth: 450, maxWidth: 600 });
    dialogDiv.centerDialog( );
    // just making sure nothing is highlighted, which looks weird
    $( ":focus" ).blur( );
  });
};

$(document).ready(function() {
  // tmp fixes for old views being used with bootstrap
  $('.bootstrap .button.default').addClass('btn btn-primary').removeClass('button default');
  $('.bootstrap .inter').addClass('btn btn-link').removeClass('inter');
  $('.bootstrap .button').addClass('btn btn-default').removeClass('button');
})
if (typeof($.fn.button) != 'undefined' && typeof($.fn.button.noConflict) != 'undefined') { 
  var bootstrapButton = $.fn.button.noConflict();
}
